#textdomain wesnoth-Galuldur

[scenario]
    id=10_Final_Battle
    name= _"10_Final_Battle"
    next_scenario=null

    map_data="{~add-ons/Galuldur/maps/10_Final_Battle.map}"

    {DEFAULT_SCHEDULE}
    turns=-1
    victory_when_enemies_defeated=no

    {GALULDUR_STORY_10}

    [side]
        side=1
        controller=human
        id=Galuldur
        type=null # just to make wmllint happy

        team_name=Galuldur
        user_team_name=_"Galuldur"

        canrecruit=yes
        recruit=Elvish Fighter,Elvish Archer,Elvish Shaman,Elvish Scout

        {GOLD 500 400 300}
        {INCOME 0 0 0}
    [/side]

    [side]
        side=2
        controller=null

        team_name=Galuldur
        user_team_name=_"Elralith"
        hidden=yes

        recruit=Elvish Fighter,Elvish Archer,Elvish Shaman,Elvish Scout,Elvish Marksman,Elvish Ranger,Elvish Hero,Elvish Rider,Elvish Druid,Elvish Sorceress,Elvish Sharpshooter,Elvish Avenger,Elvish Champion

        {GOLD 600 500 400}
        {INCOME 0 0 0}
    [/side]

    [side]
        side=3
        controller=ai
        id=Orc_Leader_W
        type=Orcish Ruler

        team_name=Orcs
        user_team_name=_"Orcs"

        recruit=Orcish Grunt,Orcish Archer,Orcish Assassin

        {GOLD 100 150 200}
        {INCOME 0 0 0}

        [ai]  # Enemies are reckless in this scenario
            aggression=0.99
            caution=0.01
            leader_aggression=0.99
            village_value=0.00
        [/ai]
    [/side]

    [side]
        side=4
        controller=ai
        id=Orc_Leader_E
        type=Orcish Ruler

        team_name=Orcs
        user_team_name=_"Orcs"

        recruit=Orcish Grunt,Orcish Archer,Orcish Assassin

        {GOLD 100 150 200}
        {INCOME 0 0 0}

        [ai]  # Enemies are reckless in this scenario
            aggression=0.99
            caution=0.01
            leader_aggression=0.99
            village_value=0.00
        [/ai]
    [/side]

    [side]
        side=5
        controller=ai
        id=Orc_Leader_S
        type=Orcish Sovereign

        team_name=Orcs
        user_team_name=_"Orcs"

        recruit=Orcish Grunt,Orcish Warrior,Orcish Archer,Orcish Crossbowman,Orcish Assassin,Orcish Slayer

        {GOLD 200 250 300}
        {INCOME 0 0 0}

        [ai]  # Enemies are reckless in this scenario
            aggression=0.99
            caution=0.01
            leader_aggression=0.99
            village_value=0.00
        [/ai]
    [/side]
    {LIMIT_CONTEMPORANEOUS_RECRUITS 5 "Orcish Warrior" 3}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 5 "Orcish Crossbowman" 3}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 5 "Orcish Slayer" 2}

    [side]
        side=6
        controller=null

        team_name=Orcs
        user_team_name=_"Undead"
        hidden=yes

        recruit=Skeleton,Deathblade,Revenant,Draug,Skeleton Archer,Bone Shooter,Banebow,Chocobone,Ghoul

        {GOLD 300 400 500}
        {INCOME 0 0 0}

        [ai]  # Enemies are reckless in this scenario
            aggression=0.99
            caution=0.01
            leader_aggression=0.99
            village_value=0.00
        [/ai]
    [/side]
    {LIMIT_CONTEMPORANEOUS_RECRUITS 6 "Draug" 1}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 6 "Banebow" 1}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 6 "Chocobone" 2}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 6 "Deathblade" 2}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 6 "Revenant" 2}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 6 "Bone Shooter" 2}

    [side]
        side=7
        controller=null

        team_name=Orcs
        user_team_name=_"Saurians"
        hidden=yes

        recruit=Saurian Augur,Saurian Oracle,Saurian Soothsayer,Saurian Skirmisher,Saurian Ambusher,Naga Fighter,Naga Warrior

        {GOLD 100 150 200}
        {INCOME 0 2 4}

        [ai]
            aggression=0.99
            caution=0.01
            leader_aggression=0.99
            leader_caution=0.01
            village_value=0.05

            [goal]
                name=protect_unit
                [criteria]
                    id=The_Chief
                [/criteria]
                protect_radius=8
                value=100
            [/goal]
            [goal]
                name=protect_unit
                [criteria]
                    side=8
                [/criteria]
                protect_radius=6
                value=25
            [/goal]
        [/ai]
    [/side]
    {LIMIT_CONTEMPORANEOUS_RECRUITS 7 "Saurian Ambusher" 1}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 7 "Saurian Oracle" 1}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 7 "Saurian Soothsayer" 1}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 7 "Naga Warrior" 1}

    [side]
        side=8
        controller=null

        team_name=Orcs
        user_team_name=_"The Chief"
        hidden=yes

        recruit=Orcish Grunt,Orcish Warrior,Orcish Warlord,Orcish Archer,Orcish Crossbowman,Orcish Slurbow,Orcish Assassin,Orcish Slayer

        {GOLD 400 500 600}
        {INCOME 0 0 0}
    [/side]
    {LIMIT_CONTEMPORANEOUS_RECRUITS 8 "Orcish Warrior" 2}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 8 "Orcish Crossbowman" 2}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 8 "Orcish Slayer" 2}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 8 "Orcish Warlord" 2}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 8 "Orcish Slurbow" 2}

    [event]
        name=prestart

        # Recall Vaddan
        [recall]
            id=Vaddan
            x,y=27,4
        [/recall]

        # Set the burnt forest to be the same as in S8
        {FOREACH stored_terrain_S8 i}
            {VARIABLE_OP stored_terrain_S8[$i].y add -43}
            [terrain]
                x,y=$stored_terrain_S8[$i].x,$stored_terrain_S8[$i].y
                terrain=$stored_terrain_S8[$i].terrain
            [/terrain]
        {NEXT i}
        {CLEAR_VARIABLE stored_terrain_S8}

        # The following is just in case we got here somehow (debug mode) without getting the
        # staff first, so that this scenario can be played anyway
        #   Give Galuldur the Saidenwaxl staff if neither Vaddan nor Galuldur has it yet
        [if]
            [variable]
                name=has_staff
                not_equals=Vaddan
            [/variable]
            [and]
                [variable]
                    name=has_staff
                    not_equals=Galuldur
                [/variable]
            [/and]
            [then]
                {SAIDENWAXL_STAFF id=Galuldur}
                {VARIABLE has_staff Galuldur}
                {NARRATOR_GRAY _"Note: Give Galuldur the Saidenwaxl Staff" _"This should never happen in normal game play. It is just set up so that the scenario is playable in debug mode. If you got here somehow without using debug commands or changing scenario files, please email me (mschoeck at tmt.org) so that I can fix it."}
            [/then]
        [/if]

        # We also disable the staff on defense until Norfindil has been converted back
        {MODIFY_UNIT id=$has_staff attack[2].defense_weight 0}

        {VARIABLE scenario_number 10}
        {VARIABLE messenger_appeared no}
    [/event]

    [event]
        name=start

        {MESSAGE Galuldur "" "" _"We need to figure out what happened here and if any of my people are still alive."}
        {MESSAGE Vaddan "" "" _"There are three orc camps right here, but they don't look strong enough to have created all this havoc, even together with those that we have already taken care of. Let's proceed carefully until we know what is going on."}
        {NARRATOR_GRAY _"Note" _"Both Galuldur and Vaddan are able to recruit in this scenario."}

        [objectives]
            [objective]
                description= _"Figure out what happened. Defeat all enemy leaders as you go along."
                condition=win
            [/objective]
            {S10_SECONDARY_OBJECTIVES}
        [/objectives]
    [/event]

    # Event: cannot use Saidenwaxl staff before Galur appears and explains
    # We need a whole bunch of events for this, both for attack and defense (messenger appears only once overall)
    # First: if used offensively, interrupt attack, have messenger appear, give staff bearer another attack in which he can use another weapon; only need this to happen once
    [event]
        name=galurs_messenger

        {SCROLL_TO 38 11}
        {UNIT 1 "Elvish Rider" 39 15 (id=tmp_rider)}
        {MOVE_UNIT id=tmp_rider 38 11}
        {MESSAGE tmp_rider "" "" _"Wait, $has_staff! Galur sent me to ..."}
        {MESSAGE Galuldur "" "" _"My father? He is alive?"}
        {MESSAGE tmp_rider "" "" _"He was the last time I saw him, but we were under heavy attack. I do not know how long he and his people can hold out. But anyway, Galur says that you must not use the magical staff to convert an enemy unit. He didn't explain further, but he said that you would understand what that means. I must go back now."}
        {MOVE_AND_KILL id=tmp_rider 39 15}
        {VARIABLE messenger_appeared yes}
    [/event]

    [event]
        name=attack  # Store and kill unit attacking with Saidenwaxl staff, only before Galur appears
        [filter_attack]
            name=Saidenwaxl Staff
        [/filter_attack]
        [if]
            [not]
                [have_unit]
                    id=Galur
                [/have_unit]
            [/not]
            [and]
                [variable]
                    name=messenger_appeared
                    equals=no
                [/variable]
            [/and]
            [then]
                [store_unit]
                    [filter]
                        id=$unit.id
                    [/filter]
                    variable=stored_SWS_unit
                    kill=yes
                [/store_unit]

                # If this happened, we need to unstore the unit at end of attack
                # No filter needed here, as it is a nested event and the next thing to happen
                [event]
                    name=attack end
                    [unstore_unit]
                        variable=stored_SWS_unit
                    [/unstore_unit]
                    {CLEAR_VARIABLE stored_SWS_unit}
                    [redraw]
                    [/redraw]

                    [fire_event]
                        name=galurs_messenger
                    [/fire_event]

                    {MESSAGE $has_staff "" "" _"I will choose a different weapon then, and I will never use the staff on defense."}
                    {MODIFY_UNIT id=$has_staff attacks_left 1}
                    [show_objectives]
                    [/show_objectives]
                [/event]
            [/then]
        [/if]
    [/event]

    # Second: if attacked with ranged weapon:
    # Staff was already disabled earlier
    [event]  # Messenger
        name=attack
        [filter_attack]
            range=ranged
        [/filter_attack]
        [filter_second]
            id=$has_staff
        [/filter_second]
        [if]
            [not]
                [have_unit]
                    id=Galur
                [/have_unit]
            [/not]
            [and]
                [variable]
                    name=messenger_appeared
                    equals=no
                [/variable]
            [/and]
            [then]
                [fire_event]
                    name=galurs_messenger
                [/fire_event]

                {MESSAGE $has_staff "" "" _"I will never defend myself with the staff then."}
                [show_objectives]
                [/show_objectives]
            [/then]
        [/if]
    [/event]

    # Event: Undead coming out of the ground
    [event]
        name=undead emerge

        # Create the cave terrain
        {SCROLL_TO 35 35}
        {DELAY 500}
        {QUAKE "rumble.ogg"}
        {MODIFY_TERRAIN Ql (36,33) (36,36)}
        {REDRAW_MOVE_DELAY 200 ()}
        {MODIFY_TERRAIN Ql (35,32,32) (36,35,36)}
        {MODIFY_TERRAIN Uh (34,34,36) (35,36,35)}
        {REDRAW_MOVE_DELAY 200 ()}
        {MODIFY_TERRAIN Ql (35,31,31) (35,35,36)}
        {MODIFY_TERRAIN Uh (33,37,37) (35,35,36)}
        {REDRAW_MOVE_DELAY 200 ()}
        {MODIFY_TERRAIN Ql (34,35,36,30,30,30) (34,34,34,34,35,36)}
        {MODIFY_TERRAIN Uh (38,38,38) (34,35,36)}
        {MODIFY_TERRAIN Uu (32) (34)}
        {REDRAW_MOVE_DELAY 200 ()}
        {MODIFY_TERRAIN Ql (33,37,29,29) (34,34,35,36)}
        {MODIFY_TERRAIN Uh (39,39) (35,36)}
        {MODIFY_TERRAIN Uu (31,32) (34,33)}
        {MODIFY_TERRAIN Ur (39) (34)}
        {REDRAW_MOVE_DELAY 200 ()}
        {MODIFY_TERRAIN Ql (33,38,28,28) (33,33,35,36)}
        {MODIFY_TERRAIN Uh (40,40,40,34) (34,35,36,33)}
        {MODIFY_TERRAIN Uu (30,31,32) (33,33,32)}
        {MODIFY_TERRAIN Ur (40,35,36,37) (34,33,33,33)}
        {MODIFY_TERRAIN Uu^Vu (29) (34)}
        {REDRAW_MOVE_DELAY 200 ()}
        {QUAKE "rumble.ogg"}
        {MODIFY_TERRAIN Ql (33,27,27,27) (32,35,36,34)}
        {MODIFY_TERRAIN Uu (28,30,31,32,36,38,39,40) (34,33,33,32,32,32,33,32)}
        {MODIFY_TERRAIN Ur (34) (32)}
        {MODIFY_TERRAIN Uu^Vud (37) (32)}
        {REDRAW_MOVE_DELAY 200 ()}
        {MODIFY_TERRAIN Ql (27,28,30) (33,31,31)}
        {MODIFY_TERRAIN Uh (25,26,26) (36,35,36)}
        {MODIFY_TERRAIN Uu (28,29,30,31,32,33,34,36,38,39,40) (33,33,32,32,31,31,31,31,31,32,31)}
        {REDRAW_MOVE_DELAY 200 ()}
        {MODIFY_TERRAIN Uh (25,26) (35,34)}
        {MODIFY_TERRAIN Uu (28,29,31) (32,32,31)}
        {REDRAW_MOVE_DELAY 200 ()}
        {MODIFY_TERRAIN Uu (26,27,27,29,30) (32,32,31,31,30)}
        {REDRAW_MOVE_DELAY 200 ()}

        # Impact craters
        {MODIFY_TERRAIN Dd^Dc (25,36) (33,30)}
        {REDRAW_MOVE_DELAY 200 cave-in.ogg}
        {MODIFY_TERRAIN Dd^Dc (32,28) (29,29)}
        {REDRAW_MOVE_DELAY 500 ()}

        # Projectiles -> Rubble
        {MODIFY_TERRAIN Ds^Dr (35) (30)}
        {REDRAW_MOVE_DELAY 200 thunderstick-short.ogg}
        {MODIFY_TERRAIN Gs^Dr (28) (28)}
        {REDRAW_MOVE_DELAY 100 thunderstick-short.ogg}
        {MODIFY_TERRAIN Gs^Dr (37) (28)}
        {REDRAW_MOVE_DELAY 500 thunderstick-short.ogg}
        {MODIFY_TERRAIN Gs^Dr (24) (25)}
        {REDRAW_MOVE_DELAY 700 thunderstick-short.ogg}
        {MODIFY_TERRAIN Gg^Dr (23) (24)}
        {REDRAW_MOVE_DELAY 300 thunderstick-short.ogg}
        {MODIFY_TERRAIN Re^Dr (18) (28)}
        {REDRAW_MOVE_DELAY 900 thunderstick-short.ogg}
        {MODIFY_TERRAIN Ce^Dr (30) (22)}
        {REDRAW_MOVE_DELAY 1000 thunderstick-short.ogg}

        # Bring out Saher-Tot
        {SCROLL_TO 35 35}
        {QUAKE "rumble.ogg"}
        {DELAY 1000}
        {MODIFY_TERRAIN Cud (30) (36)}
        {REDRAW_MOVE_DELAY 300 ()}
        {MODIFY_TERRAIN Cud (29,30,31) (36,35,36)}
        {MODIFY_TERRAIN Kud (30) (36)}
        {REDRAW_MOVE_DELAY 300 ()}
        {MODIFY_TERRAIN Cud (29,30,31,30) (35,34,35,36)}
        {MODIFY_TERRAIN Kud (30) (35)}
        {REDRAW_MOVE_DELAY 1000 ()}

        {SOUND lightning.ogg}
        {NEW_LEADER_APPEARS 6 (Ancient Lich) 30 35 Saher-Tot (name=Saher-Tot)}
        {ADVANCE_UNIT id=Saher-Tot (Ancient Lich)}
        {SOUND lightning.ogg}
        {ADVANCE_UNIT id=Saher-Tot (Ancient Lich)}
        {SOUND lightning.ogg}
        {ADVANCE_UNIT id=Saher-Tot (Ancient Lich)}

        {VARIABLE stored_undead_Norfindil.side 6}
        {VARIABLE stored_undead_Norfindil.canrecruit no}
        [unstore_unit]
            variable=stored_undead_Norfindil
            find_vacant=yes
            x,y=31,35
        [/unstore_unit]
        {CLEAR_VARIABLE stored_undead_Norfindil}
        {FULL_HEAL id=Norfindil}
        {MAKE_HERO Norfindil}

        {MESSAGE Saher-Tot "" "" "What is going on here? I can feel the presence of my staff in the hands of an unbeliever. Do I really have to do all the work myself?"}
        {MESSAGE Galuldur "" _"Galuldur (whispers)" {WHISPER _"An ancient Lich? I didn't know that there were any of them left."}}
        {MESSAGE Vaddan "" _"Vaddan (whispers)" {WHISPER _"Neither did I. He must be the one they keep calling the Master. And did you see that the undead version of Norfindil is with him? Did I mention that I am getting <u>really</u> tired of all these undead popping up all over the place?"}}
        {MESSAGE Saher-Tot "" "" "Hello?! I can hear you just fine over here. My hearing is one of my finer qualities. None of that sound absorbing soft tissue, you know. Yes, I am the one they call the Master. And soon you will do the same."}
        {MESSAGE Galuldur "" "" _"Over my dead body!"}
        {MESSAGE Saher-Tot "" "" _"That can be arranged. Open the portals!"}

        {MODIFY_TERRAIN Cud (27,33,38) (33,32,33)}
        {REDRAW_MOVE_DELAY 100 magic-dark-big.ogg}
        {PLACE_IMAGE (scenery/whirlpool.png) 27 33}
        {PLACE_IMAGE (scenery/whirlpool.png) 33 32}
        {PLACE_IMAGE (scenery/whirlpool.png) 38 33}
        {REDRAW_MOVE_DELAY 300 ()}

        {REMOVE_IMAGE 27 33}
        {REMOVE_IMAGE 33 32}
        {REMOVE_IMAGE 38 33}
        {REDRAW_MOVE_DELAY 100 magic-dark-big.ogg}
        {MODIFY_TERRAIN Ql (27,33,38) (33,32,33)}
        {REDRAW_MOVE_DELAY 300 ()}

        {MODIFY_TERRAIN Cud (27,33,38) (33,32,33)}
        {REDRAW_MOVE_DELAY 100 magic-dark-big.ogg}
        {PLACE_IMAGE (scenery/whirlpool.png) 27 33}
        {PLACE_IMAGE (scenery/whirlpool.png) 33 32}
        {PLACE_IMAGE (scenery/whirlpool.png) 38 33}
        {REDRAW_MOVE_DELAY 300 ()}

        {REMOVE_IMAGE 27 33}
        {REMOVE_IMAGE 33 32}
        {REMOVE_IMAGE 38 33}
        {REDRAW_MOVE_DELAY 100 magic-dark-big.ogg}
        {MODIFY_TERRAIN Ql (27,33,38) (33,32,33)}
        {REDRAW_MOVE_DELAY 300 ()}

        {MODIFY_TERRAIN Cud (27,33,38) (33,32,33)}
        {REDRAW_MOVE_DELAY 100 magic-dark-big.ogg}
        {PLACE_IMAGE (scenery/whirlpool.png) 27 33}
        {PLACE_IMAGE (scenery/whirlpool.png) 33 32}
        {PLACE_IMAGE (scenery/whirlpool.png) 38 33}
        {REDRAW_MOVE_DELAY 1500 ()}

        # Set some variables
        {VARIABLE portal_probability 20}
        {VARIABLE turns_since_ST -1}

        [objectives]
            [objective]
                description= _"Defeat the Master and all other enemy leaders."
                condition=win
            [/objective]
            {S10_SECONDARY_OBJECTIVES}
        [/objectives]

        # Nested event: From now on, undead units also appear at the portals
        [event]
            name=side 6 turn
            first_time_only=no

            # All of this only happens if Saher-Tot is alive
            [if]
                [have_unit]
                    id=Saher-Tot
                [/have_unit]
                [then]
                    # Set up probabilities and types of units to come through portals
                    {VARIABLE_OP portal_probability add 5}

                    [if]
                        [variable]
                            name=portal_probability
                            greater_than=75
                        [/variable]

                        [then]
                            {VARIABLE portal_probability 75}
                        [/then]
                    [/if]

                    {VARIABLE_OP turns_since_ST add 1}
                    # The following would be easier using [case] in V 1.9 and up...
                    {VARIABLE undead_types (Skeleton,Skeleton Archer)}

                    [if]
                        [variable]
                            name=turns_since_ST
                            greater_than=3
                        [/variable]

                        [then]
                            {VARIABLE undead_types (Skeleton,Skeleton Archer,Revenant,Bone Shooter)}
                        [/then]
                    [/if]

                    [if]
                        [variable]
                            name=turns_since_ST
                            greater_than=7
                        [/variable]

                        [then]
                            {VARIABLE undead_types (Revenant,Bone Shooter)}
                        [/then]
                    [/if]

                    [if]
                        [variable]
                            name=turns_since_ST
                            greater_than=11
                        [/variable]

                        [then]
                            {VARIABLE undead_types (Revenant,Bone Shooter,Draug,Banebow)}
                        [/then]
                    [/if]

                    {UNDEAD_THROUGH_PORTAL 27 33}
                    {UNDEAD_THROUGH_PORTAL 33 32}
                    {UNDEAD_THROUGH_PORTAL 38 33}
                [/then]
            [/if]
        [/event]

        # Nested event: Galur appears the turn after Saher-Tot
        [event]
            name=new turn

            {GALUR 1 39 11 (
                hitpoints=13
                experience=52
            )}

            {UNIT 1 "Elvish Rider" 38 10 (hitpoints,experience,random_traits=2,27,yes)}
            {UNIT 1 "Elvish Shyde" 38 11 (hitpoints,experience,random_traits=26,45,yes)}
            {UNIT 1 "Elvish Sorceress" 37 11 (hitpoints,experience,random_traits=14,58,yes)}
            {UNIT 1 "Elvish Lord" 37 12 (hitpoints,experience,random_traits=19,7,yes)}
            {UNIT 1 "Elvish Archer" 38 12 (hitpoints,experience,random_traits=13,10,yes)}

            {MESSAGE Galur "" "" _"Galuldur, I have come to warn you of the undead. I see that I am too late."}
            {MESSAGE Galuldur "" "" _"Father! I thought I would never see you again!!"}
            {MESSAGE Galur "" "" _"It did not look like you would at times. Since you left Pindir Forest, we have been fighting the orcs and trying to figure out why they were suddenly all working together. We learned some very disturbing things about a powerful undead somehow making his way to our world and using his magical powers to organize the orcs. It looks like you have already been introduced."}
            {MESSAGE Galur "" "" _"We must destroy the Master, it is the only chance we have to break his hold on the orcs and to bring peace back to our land. This will be very difficult, his magic is so strong that any unit attacking him with non-magical weapons goes insane after the attack. To help with our task, I have rounded up all surviving elves with magical powers that I could find. Many elves died making sure that they would get this far. May their deaths not be in vain."}
            {MESSAGE Galur "" "" _"Also, do you see those portals he opened? He can bring undead through them from wherever he came. We can disable a portal by placing one of our units directly on it and they will all be permanently closed if we can kill the Master. We must hurry, they are only partially open so far. The longer we wait, the more easily the Master will bring units through them and the more powerful those units will be."}
            {MESSAGE Galur "" "" _"One more thing, we must save Norfindil. I owe it to him that I do not leave him in the hands of the undead. I see that you have the Saidenwaxl Staff, $has_staff. You must use it to turn Norfindil back over to our side."}

            {CLEAR_VARIABLE messenger_appeared}  # So that objectives change accordingly

            {VARIABLE Norfindil_objective _"Convert Norfindil back to Galuldur's side. Defeat"}
            {VARIABLE main_enemy _"Master"}
            [objectives]
                [objective]
                    description= _"$Norfindil_objective the $main_enemy and all other enemy leaders."
                    condition=win
                [/objective]
                {S10_SECONDARY_OBJECTIVES}
            [/objectives]
        [/event]
    [/event]

    # There are 3 possible events that trigger the undead coming out
    # 1: Less than 18 orc units left from Turn 5 on (this is the one likely to happen)
    #    This is done in the bundled 'die' events at the end
    # 2: Galuldur's group moves far enough south
    [event]
        name=moveto
        [filter]
            side=1
            y=19-99
        [/filter]
        [fire_event]
            name=undead emerge
        [/fire_event]
    [/event]
    # 3: None of this has happened by Turn 15 (should be unlikely)
    [event]
        name=side 1 turn 15  # Use this syntax rather than 'turn 15', so that 'new turn' sub event happens _next_ turn, not this turn
        [fire_event]
            name=undead emerge
        [/fire_event]
    [/event]

    # Event: Unit attacking Saher-Tot with non-magical weapon goes insane after the attack
    [event]
        name=attack end
        first_time_only=no
        [filter_second]
            id=Saher-Tot
        [/filter_second]
        [filter_attack]
            [not]
                special=magical
            [/not]
        [/filter_attack]

        {MESSAGE unit "" "" _"Aaah! It burns!!!"}
        # Runs around like crazy
        {REPEAT 7 (
            {CLOSE_EMPTY_HEX $unit.x $unit.y Ql 3}
            {MOVE_UNIT id=$unit.id $hex_x $hex_y}
        )}
        {CLEAR_VARIABLE hex_x}
        {CLEAR_VARIABLE hex_y}

        # Commits suicide into random lava hex
        [store_map_dimensions]
            variable=map_dims2  # cannot use (clear variable) map_dims, needed for Elralith menu
        [/store_map_dimensions]
        [store_locations]
            terrain=Ql
            variable=tmp_terrain
            x=1-$map_dims2.width
            y=1-$map_dims2.height  # needed to exclude edge tiles
        [/store_locations]
        {VARIABLE i_t $tmp_terrain.length}
        {VARIABLE_OP i_t add -1}
        {RANDOM 0..$i_t}

        # In 1.9, MOVE_UNIT works differently, need to make lava walkable
        {MODIFY_UNIT id=$unit.id movement_costs.unwalkable 1}
        {MOVE_UNIT id=$unit.id $tmp_terrain[$random].x $tmp_terrain[$random].y}
        {FIREBALL $tmp_terrain[$random].x $tmp_terrain[$random].y}
        {CLEAR_VARIABLE tmp_terrain}
        {CLEAR_VARIABLE i_t}
        {CLEAR_VARIABLE random}
        {CLEAR_VARIABLE map_dims2}
        [kill]
            id=$unit.id
            animate=yes
        [/kill]
        # If it is one of the player's sides heroes doing this, end the game
        # We cannot use the standard death events because of one unlikely, but not
        # impossible combination of events (Saher-Tot being killed by one of the heroes
        # and him being the last of the enemy leaders) that would otherwise also trigger
        # the victory condition
        [if]
            [variable] # I guess I could check for canrecruit/is_hero or something also...
                name=unit.id
                equals=Galuldur
            [/variable]
            [or]
                [variable]
                    name=unit.id
                    equals=Vaddan
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.id
                    equals=Galur
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.id
                    equals=Norfindil
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.id
                    equals=Elralith
                [/variable]
            [/or]
            [then]
                {MESSAGE Vaddan "" "" _"$unit.id! We cannot go on without you."}
                {MESSAGE Galuldur "" "" _"This really is the end then."}
                [endlevel]
                    result=defeat
                [/endlevel]
            [/then]
        [/if]
    [/event]

    # Event: Elralith appears after first attack on undead; not if attacker uses
    #   Saidenwaxl Staff or if the attacked unit is Norfindil or Saher-Tot. Or even if
    #   the first attacker is one of the player's hero units (in case he dies). This is to
    #   make sure the order in which this and other events happen is correct
    #   Granted, some of this is essentially impossible, but since it is easy...
    [event]
        name=attack end
        [filter_second]
            side=6
            [not]
                id=Norfindil
            [/not]
            [not]
                id=Saher-Tot
            [/not]
        [/filter_second]
        [filter]
            [not]
                id=Galuldur
            [/not]
            [not]
                id=Vaddan
            [/not]
            [not]
                id=Galur
            [/not]
            [not]
                id=Norfindil
            [/not]
            [not]
                id=Elralith
            [/not]
        [/filter]
        [filter_attack]
            [not]
                name=Saidenwaxl Staff
            [/not]
        [/filter_attack]

        [unstore_unit]
            variable=stored_Elralith
            find_vacant=yes
            x,y=2,10
        [/unstore_unit]
        {CLEAR_VARIABLE stored_Elralith}

        [modify_side]
            side=2
            hidden=no
            controller=ai
        [/modify_side]

        {MESSAGE Elralith "" "" _"Galur, we have come to help you in your battle. Your son fought well at Ultwildir. He will make a good elf leader some day. But for now, we must take care of the problem at hand. I bear more bad news. Apparently, Saher-Tot, the one they call the Master, is not the mastermind of this uprising. We must defeat him, but I am afraid that that is not the end of our troubles."}

        {NARRATOR_GRAY _"Note" _"You can again make Elralith go to a location of your choice â€” or, afterward, clear that goal - by right clicking on a tile and selecting the respective option."}

        {MENU_ELRALITH_CONTROL 2}
        {CLEAR_ELRALITH_MENU}  # Event that is triggered on victory

        {VARIABLE chief_trigger $turn_number}
        {VARIABLE_OP chief_trigger add 6}  # Chief appears 6 turns later

        # Update the objectives (happens automatically)
        [show_objectives]
        [/show_objectives]
    [/event]

    # Event: Saher-Tot dies - close the portals
    [event]
        name=Saher-Tot dies
        [filter]
            id=Saher-Tot
        [/filter]

        # Close portals and clean up variables
        {REMOVE_IMAGE 27 33}
        {REMOVE_IMAGE 33 32}
        {REMOVE_IMAGE 38 33}
        {CLEAR_VARIABLE portal_probability}
        {CLEAR_VARIABLE turns_since_ST}
        {CLEAR_VARIABLE undead_types}

        # Also call the Chief, if he has not appeared yet
        [fire_event]
            name=chief appears
        [/fire_event]
    [/event]

    # Event: The Chief appears
    [event]  # Trigger event (can also be fired by Saher-Tot dying)
        name=new turn
        first_time_only=no
        [if]
            [variable]
                name=turn_number
                equals=$chief_trigger
            [/variable]

            [then]
                [fire_event]
                    name=chief appears
                [/fire_event]
            [/then]
        [/if]
    [/event]
    [event]  # The event itself
        name=chief appears
        {CLEAR_VARIABLE chief_trigger}
        {MESSAGE Galuldur "" "" _"Something is happening over there in the west"}
        {SCROLL_TO 2 10}
        [move_unit_fake]
            type=Transport Galleon
            side=8
            x=1,2,8
            y=27,24,24
        [/move_unit_fake]
        {GENERIC_UNIT 8 (Transport Galleon) 8 24}

        # If there are Side 1 or 2 units within 11 hexes, teleport them away
        [store_unit]
            [filter]
                side=1,2
                [filter_location]
                    x,y=9,25
                    radius=11
                [/filter_location]
            [/filter]
            variable=tmp_units
            mode=append
        [/store_unit]

        {FOREACH tmp_units i_tele}
            [if]
                [variable]
                    name=i_tele
                    equals=0
                [/variable]

                [then]
                    {MESSAGE $tmp_units[$i_tele].id "" "" _"What is happening??? I am being teleported away!"}
                [/then]
            [/if]

            {TELEPORT_AWAY id=$tmp_units[$i_tele].id 9 25 12}
        {NEXT i_tele}
        {CLEAR_VARIABLE tmp_units}

        # Then, the Chief
        {NEW_LEADER_APPEARS 8 (Goblin Mage) 9 25 The_Chief (name=The Chief)}
        {MESSAGE The_Chief "" "" _"Who dares interfering with my Grand Plan? Oh, it's those damned elves again. I should have known!"}
        {MESSAGE Galuldur "" "" _"What the hell is this? A puny little goblin?"}
        {MESSAGE Vaddan "" "" _"Actually, have a look at his weapons and vitals. This is no ordinary goblin."}
        {MESSAGE The_Chief "" "" _"You are damned right that I am no ordinary goblin. I am the Chief of all creatures in this part of the world."}
        {MESSAGE Galuldur "" "" _{WHISPER _"He is amazingly eloquent. Well, for a goblin anyway."}+"  Good that we aren't creatures then. We are here to end your ''reign''."}
        {MESSAGE The_Chief "" "" _"Hah! We will see about that. The orcs never took me seriously either. They think that they can treat us goblins like dirt. After all, we are but the weaklings of the litter. And they are right, we cannot match them physically, but some of us have the brains that they lack, together with a gift for magic. And so I can rule the undead and, through them, the orcs. And everybody else."}
        {MESSAGE Galuldur "" "" _"Except for the elves."}
        {MESSAGE The_Chief "" "" _"Don't be too full of yourselves. You are but a pebble on my road to ruling the world. I will make you pay for what you have done."}

        # Create the camp
        [terrain]
            x=9,9,10,10
            y=24,26,24,25
            terrain=Ce
        [/terrain]
        [terrain]
            x,y=9,25
            terrain=Ke
        [/terrain]
        [redraw]
        [/redraw]

        [kill]
            type=Transport Galleon
        [/kill]
        [move_unit_fake]
            type=Transport Galleon
            side=8
            x=8,2,2,5
            y=25,25,29,32
        [/move_unit_fake]
        {GENERIC_UNIT 8 (Transport Galleon) 5 32}

        # Then unstore the saurian leader
        {NEW_LEADER_APPEARS 7 (Saurian Flanker) 6 31 Saurian_Leader ()}
        {MOVE_UNIT id=Saurian_Leader 8 30}
        # Create the camp
        [terrain]
            x=7,7,8
            y=30,31,29
            terrain=Ce
        [/terrain]
        [terrain]
            x,y=8,30
            terrain=Ke
        [/terrain]
        [redraw]
        [/redraw]

        {MOVE_AND_KILL (type=Transport Galleon) 1 29}

        {MESSAGE Saurian_Leader "" "" _"We follow you, Chief."}

        {VARIABLE main_enemy Chief}
        [objectives]
            [objective]
                description= _"$Norfindil_objective the $main_enemy and all other enemy leaders."
                condition=win
            [/objective]
            {S10_SECONDARY_OBJECTIVES}
        [/objectives]
    [/event]

    # If the Chief gets attacked...
    [event]
        name=first_time_teleport

        {MESSAGE Norfindil "" "" _"Oh, is this what the Master was talking about? He spent all his time looking for this enemy of his, trying to break some sort of spell. He called him ''untouchable'', but I never understood why. Of course, we were searching for a great warrior, not a goblin."}
        {MESSAGE Norfindil "" "" _"The Master did eventually figure out how to defeat this enemy and now I understand what he meant. First, the Chief draws most of his powers from the undead around him. As long as there are undead alive on a side allied with him, he cannot be attacked. But even if all undead have been destroyed, he is still strong enough to teleport away any unit with which he has direct eye contact. However, having an allied unit behind the Chief, on the opposite side of the attacker, distracts him enough that an attack is possible. That's the Master's theory at least, we will have to see if it works in practice."}
    [/event]

    [event]
        name=attack
        first_time_only=no
        [filter_second]
            id=The_Chief
        [/filter_second]

        # Find hex opposite from attacker w.r.t Chief
        {FIND_OPPOSITE_HEX $second_unit.x $second_unit.y $unit.x $unit.y}

        # Attacking unit gets teleported away if there are undead left on a side allied with the Chief
        #  or if there is not an allied unit on the opposite side of the Chief
        [if]
            [have_unit]
                side=3,4,5,6,7,8
                race=undead
            [/have_unit]
            [or]
                [not]
                    [have_unit]
                        side=1,2
                        x,y=$x_opp,$y_opp
                    [/have_unit]
                [/not]
            [/or]

            [then]
                {TELEPORT_AWAY id=$unit.id $second_unit.x $second_unit.y 8}

                [fire_event]
                    name=first_time_teleport
                [/fire_event]
            [/then]
        [/if]

        {CLEAR_VARIABLE x_opp}
        {CLEAR_VARIABLE y_opp}
    [/event]

    # These need to come first, as Norfindil is on Side 6 to start with
    # and his death needs to trigger before one of the following.
    # Actually, this might not be necessary any more, but I'll leave it anyway
    {DEATH_EVENTS}
    {VADDAN_DEATH_DEFEAT}

    # Event: As in S8, the 'die' events are bunched together here, as some might have to
    #  fire on the same death and in the right order. Not all of them do, but just for consistency, I'll leave it that way
    #  Mostly this is important here in case the Norfindil conversion is the last thing that
    #  happens in the scenario, and to keep the order of things right
    # 1: Transmutation
    # 2: Less than 18 orc units left from Turn 5 on -> trigger Saher-Tot
    # 3: Saher-Tot dies -> trigger the Chief
    # 3A: Chief dies -> gets death speech
    # 4: Victory when all enemy leaders are defeated
    [event]
        name=die
        first_time_only=no
        [filter]
            side=3,4,5,6,7,8
        [/filter]
        # 1: Transmutation; can simply always fire it, event itself will take care of filtering
        #    and triggering only once
        [fire_event]
            name=transmutation event
            [primary_unit]
                id=$unit.id
            [/primary_unit]
            [secondary_unit]
                id=$second_unit.id
            [/secondary_unit]
            [secondary_attack]
                name=$second_weapon.name
            [/secondary_attack]
        [/fire_event]

        # 2: Less than 18 orc units left from Turn 5 on -> trigger Saher-Tot
        {COUNT_UNITS side=3,4,5}
        [if]
            [variable]
                name=unit_count
                less_than_equal_to=18  # the currently killed unit still counts
            [/variable]
            [and]
                [variable]
                    name=turn_number
                    greater_than=4
                [/variable]
            [/and]
            [and]  # This is necessary, otherwise defeat event does not happen until after this event,
                # if caused by wrong use of Saidenwaxl Staff.
                # Obviously, this cannot be the Norfindil conversion (he's not there yet)
                [variable]
                    name=second_weapon.name
                    not_equals=Saidenwaxl Staff
                [/variable]
            [/and]
            [then]
                [fire_event]
                    name=undead emerge
                [/fire_event]
            [/then]
        [/if]
        {CLEAR_VARIABLE unit_count}

        # 3: Saher-Tot dies -> trigger the Chief
        #    can simply always fire it (except when SWS is used, and Norfindil
        #    not converted yet - do that here so that events fire in right order,
        #    not because it wouldn't work otherwise).
        #    Event itself will otherwise take care of filtering and triggering only once
        [if]
            [not]
                [variable]
                    name=second_weapon.name
                    equals=Saidenwaxl Staff
                [/variable]
                [have_unit]
                    side=6
                    id=Norfindil
                [/have_unit]
            [/not]
            [then]
                [fire_event]
                    name=Saher-Tot dies
                    [primary_unit]
                        id=$unit.id
                    [/primary_unit]
                [/fire_event]
            [/then]
        [/if]

        # 3A: The Chief dies -> speech
        [if]
            [variable]
                name=unit.id
                equals=The_Chief
            [/variable]
            [then]
                {MESSAGE The_Chief "" "" _"No !!! It cannot be. My Grand Plan..."}
                [if]
                    [have_unit]
                        side=3,4,5,6,7,8
                        canrecruit=yes
                    [/have_unit]
                    [then]
                        {MESSAGE Galuldur "" "" _"Good, this was the hard part. Now let's finish off the rest."}
                    [/then]
                [/if]
            [/then]
        [/if]

        # 4: Victory when Chief has appeared, all enemy leaders are defeated and Norfindil has been converted
        [if]
            [not]
                [have_unit]
                    side=3,4,5,6,7,8
                    canrecruit=yes
                [/have_unit]
            [/not]
            # And, in case Saher-Tot and all other enemy leaders get killed before the Chief appears
            [variable]
                name=main_enemy
                equals=Chief
            [/variable]
            # Do not need to check whether Norfindil is converted, as
            # Chief cannot get attacked beforehand (since he is an undead)
            [then]
                {MESSAGE Galuldur "" "" _"We did it, it's over!"}

                {STORE_UNIT_VAR id=Galuldur type Galuldur_type}
                [if]
                    [variable]
                        name=Galuldur_type
                        equals=Elvish Hero
                    [/variable]

                    [then]
                        {VARIABLE str "In fact, he was an Elvish Hero, but that's not what I mean."}
                    [/then]

                    [else]
                        {VARIABLE str "But not an Elvish Hero, because, in fact, he was an "+$Galuldur_type+". But that's not what I mean."}
                    [/else]
                [/if]

                {NARRATOR_GRAY "" _"And that is how Galuldur became a man. Well, an elf. But not just any elf, but an elf man. I mean, an elf hero. $str You know what I mean. Now let's go inside and have dinner before Mom gets angry."}
                {CLEAR_VARIABLE Galuldur_type}
                {CLEAR_VARIABLE str}

                {CLEAR_VARIABLE scenario_number}
                {CLEAR_VARIABLE Norfindil_objective}
                {CLEAR_VARIABLE main_enemy}
                {CLEAR_VARIABLE has_staff}
                {CLEAR_VARIABLE staff_used}
                {CLEAR_VARIABLE chosen_route}

                [endlevel]
                    result=victory
                    bonus=yes
                    carryover_add=yes
                    carryover_percentage=40
                    carryover_report=no
                    linger_mode=yes
                [/endlevel]
            [/then]
        [/if]
    [/event]

    # Standard Events
    {STAFF_USED_FIRST_TIME}
    {TRANSMUTATION_EVENT}

    {ORCS_MOVE_FAST 3,4,5,6,7,8}
    {BURN_ON_MOVE_S8_10 3,4,5,6,7,8}
[/scenario]
