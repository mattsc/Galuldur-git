#textdomain wesnoth-Galuldur

[scenario]
    id=02_The_High_Plains
    name= _"02_High_Plains"
    next_scenario=03_Eldryanic_Swamps

    map_data="{~add-ons/Galuldur/maps/02_The_High_Plains.map}"

    {DEFAULT_SCHEDULE}
    {TURNS 48 40 40}  # Taking gold away means it takes longer ...
    # -> same # of turns for medium and hard
    victory_when_enemies_defeated=no

    {GALULDUR_STORY_02}

    [side]
        side=1
        controller=human
        id=Galuldur
        type=null # just to make wmllint happy

        team_name=Galuldur
        user_team_name=_"Galuldur"

        fog=yes
        shroud=yes

        {GOLD 150 100 80}
        {INCOME 0 0 0}
    [/side]

    {RANDOM_FOES_SIDE 2}

    [side]
        side=3
        controller=null

        team_name=Vaddan
        user_team_name=_"Vaddan"
        hidden=yes

        recruit=Footpad,Thug,Outlaw,Bandit,Thief

        {GOLD 75 100 125}
        {INCOME 0 0 0}
    [/side]
    # Don't let him have too many level 2 units
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 "Outlaw" 2}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 "Bandit" 1}

    [side]  # SW Orcs
        side=4
        controller=null

        team_name=Orcs
        user_team_name=_"Orcs"
        hidden=yes

        recruit=Orcish Grunt,Orcish Warrior,Orcish Archer,Orcish Assassin

        {GOLD 100 150 200}
        {INCOME 0 0 0}
    [/side]
    # Don't let him have too many level 2 units
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 "Orcish Warrior" 2}

    [side]  # SE Orcs 1
        side=5
        controller=null

        team_name=Orcs
        user_team_name=_"Orcs"
        hidden=yes

        recruit=Orcish Grunt,Orcish Warrior,Orcish Archer,Orcish Crossbowman,Orcish Assassin,Orcish Slayer

        {GOLD 200 250 300}
        {INCOME 0 0 0}
    [/side]

    [side]  # SE Orcs 2
        side=6
        controller=null

        team_name=Orcs
        user_team_name=_"Orcs"
        hidden=yes

        recruit=Orcish Grunt,Orcish Warrior,Orcish Archer,Orcish Crossbowman,Orcish Assassin,Orcish Slayer

        {GOLD 200 250 300}
        {INCOME 0 0 0}
    [/side]

    [event]
        name=prestart

        {SET_LABEL 42 5 _"Pass of Hangarn"}
        {PLACE_IMAGE (scenery/signpost.png) 42 5}
        {SET_LABEL 28 33 _"Adlewys Passage"}
        {PLACE_IMAGE (scenery/signpost.png) 28 33}
        {SET_LABEL 3 39 _"Pleasant Passage"}
        {PLACE_IMAGE (scenery/signpost.png) 3 39}
    [/event]

    [event]
        name=start

        {MESSAGE Galuldur "" "" _"So this is the Pass of Hangarn. But now what? Where is this Norfindil?"}

        {NORFINDIL}
        [+unit]
            x,y=41,6
            {IS_HERO}
        [/unit]

        {MESSAGE Norfindil "" "" _"I am right here. And you have made it too, I see. Not bad for a bunch of youngsters. You better recruit a few more elves though, these parts are a bit more dangerous than cozy Pindir Forest."}
        {MESSAGE Galuldur "" "" _"Where would I find elves in this barren land? I thought all elves live in the forests."}
        {MESSAGE Norfindil "" "" _"That's what our glorious leaders want you to believe, but there are elves almost anywhere. Not many, mind you, but if all you need is a few mercenaries, you can always find those. And aren't we lucky that there is an old fortress right here on this side also."}
        {MESSAGE Galuldur "" "" _"I guess so. But what do we do then? Which way do we take across the plains? You said you could guide us."}
        {MESSAGE Norfindil "" "" _"I never said that, that was you. I do know the way to Ultwildir, but by the coastal route down in the south. Up here, I only know the parts east of the river."}

        [modify_side]
            side=1
            shroud_data="{~add-ons/Galuldur/maps/02_The_High_Plains_Shroud.map}"
        [/modify_side]

        {MESSAGE Norfindil "" "" _"The High Plains used to be part of a busy trade route many centuries ago. You can still see some remains of that time, but since the fall of the old kingdoms, the plains have fallen into disarray and all sorts of foul creatures roam here. Until all the orc commotions started recently, it was safer to take the longer route along the coast."}

        {MESSAGE Norfindil "" "" _"While you were quarreling with those orcs at the pass, I did some scouting in the south-east. There are two large orc camps down there, right by Adlewys Passage. I strongly suggest that you avoid those. They will probably stay put as long as you don't get too close. They do not expect anybody coming from the north other than the occasional ogre or troll."}
        {MESSAGE Norfindil "" "" _"The plateau is surrounded by impassable mountains on all sides except in the south. The river can only be crossed in a few spots and I do not know what lies on the other side, but it cannot be much worse than those south-eastern orc camps. I suggest that you try your luck in the west and somehow make your way to the not-so-aptly named Pleasant Passage in the south-west."}

        [objectives]
            [objective]
                description= _"Move Galuldur to Pleasant Passage"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Galuldur"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Norfindil"
                condition=lose
            [/objective]
            [objective]
                description= _ "Turns run out"
                condition=lose
            [/objective]
            note={EARLY_FINISH_BONUS_NOTE}+{NEW_GOLD_CARRYOVER_NOTE_40}
        [/objectives]
    [/event]

    # Event: Vaddan appears on turn 4, steals letter
    [event]
        name=turn 4
        {STORE_UNIT_VAR (id=Galuldur) x Galuldur_x}
        {STORE_UNIT_VAR (id=Galuldur) y Galuldur_y}
        [store_gold]
            side=1
            variable=stolen_gold
        [/store_gold]

        {VADDAN}
        [+unit]
            side=3
            x,y=$Galuldur_x,$Galuldur_y
        [/unit]

        [modify_side]
            side=3
            hidden=no
            controller=ai
        [/modify_side]

        # There are two units with Vaddan
        [unit]
            side=3
            type=Bandit
            id=Wurmad
            name=_"Wurmad"
            x,y=$Galuldur_x,$Galuldur_y
        [/unit]
        {GENERIC_UNIT 3 Footpad $Galuldur_x $Galuldur_y}
        {CLEAR_VARIABLE Galuldur_x}
        {CLEAR_VARIABLE Galuldur_y}

        {MESSAGE Vaddan "" "" _"Stop! Put down your weapons and give me all your gold."}

        # IF the happen to be in deep water or on impassable mountains
        [if]
            [have_unit]
                side=3
                [filter_location]
                    terrain=Wo,*^Xm
                [/filter_location]
            [/have_unit]
            [then]
                {VARIABLE str "  And how did they get onto that terrain?!?"}
            [/then]
            [else]
                {VARIABLE str ""}
            [/else]
        [/if]
        {MESSAGE Galuldur "" "" _"What ... what is going on here? Where did they come from?"+$str}
        {CLEAR_VARIABLE str}

        {MESSAGE Vaddan "" "" _"Just an old-fashioned hold-up. Now give me all your gold."}
        {MESSAGE Galuldur "" "" _"You cannot do that. If we do not complete our mission, all elves in these parts will die."}
        {MESSAGE Vaddan "" "" _"What do I care about elves? Wurmad, take whatever they have and let's get out of here."}

        {IF_VAR stolen_gold greater_than 0 (
            [then]
                {MESSAGE Wurmad "" "" _"He has "+$stolen_gold+" gold. And I also found this."}
            [/then]
            [else]
                {MESSAGE Wurmad "" "" _"He has no gold. But I found this."}
            [/else]
        )}
        {MESSAGE Galuldur "" "" _"No!! You cannot take that letter!"}
        {MESSAGE Vaddan "" "" _"Whatever it is, let's take it and get out of here!"}

        {IF_VAR stolen_gold greater_than 0 (
            [then]
                [modify_side]
                    side=1
                    gold=0
                [/modify_side]
            [/then]
        )}

        {MOVE_UNIT id=Vaddan 21 17}
        {MOVE_UNIT id=Wurmad 20 16}
        {MOVE_UNIT type=Footpad 21 16}

        {MESSAGE Galuldur "" "" _"I will not be able to convince Elralith to join us without that letter. We have to go after them and get it back. It looks like they went to the western side of the river."}

        # New objective
        [objectives]
            [objective]
                description= _"Get the letter back by defeating Vaddan"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Galuldur"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Norfindil"
                condition=lose
            [/objective]
            [objective]
                description= _ "Turns run out"
                condition=lose
            [/objective]
            note={EARLY_FINISH_BONUS_NOTE}+{NEW_GOLD_CARRYOVER_NOTE_40}
        [/objectives]
    [/event]

    # Event: As Vaddan gets killed, he asks to join Galuldur
    [event]
        name=last breath
        [filter]
            id=Vaddan
        [/filter]

        {IF_VAR second_unit.side equals 1 (
            [then]
                {MESSAGE Vaddan "" "" _"Don't kill me! Here is your letter back."}
                {MESSAGE Galuldur "" "" _"Tell me one good reason why I should not kill you."}
            [/then]
            [else]
                {MESSAGE Vaddan "" "" _"Don't let them kill me! I'll give you your letter back."}
                {MESSAGE Galuldur "" "" _"Tell me one good reason why I should protect you."}
            [/else]
        )}
        {MESSAGE Vaddan "" "" _"Well, for starters, I know the High Plains very well and can show you the best way out of here. And it looks like you could use another experienced fighter."}
        {MESSAGE Norfindil "" "" _"Don't trust him. He will jump at the first chance he gets to betray you."}

        [message]
            speaker=Galuldur

            # Option: Do not let Vaddan join
            [option]
                message=_"I do not trust him, he must die."
                [command]
                    {VARIABLE Vaddan_joins no}
                    {MESSAGE Vaddan "" "" _"Hah! You cannot get rid of me this easily. You have not seen the last of me yet!"}
                    # Store away for later use
                    {MODIFY_UNIT id=Vaddan hitpoints 1}
                    [store_unit]
                        [filter]
                            id=Vaddan
                        [/filter]
                        variable=killed_Vaddan
                        kill=yes
                    [/store_unit]
                    [if]
                        [have_unit]
                            side=3
                        [/have_unit]
                        [then]
                            [kill]
                                side=3
                            [/kill]
                            {MESSAGE Galuldur "" "" _"Where did they all go? Well, it doesn't matter. At least I have my letter back. It also looks like he dropped some gold and a map of the plains. Now let's get going.."}
                        [/then]
                        [else]
                            {MESSAGE Galuldur "" "" _"Where did he go? Well, it doesn't matter. At least I have my letter back. It also looks like he dropped some gold and a map of the plains. Now let's get going."}
                        [/else]
                    [/if]
                    {IF_VAR stolen_gold greater_than 51 (
                        [then]
                            {VARIABLE_OP stolen_gold divide 2}
                            [gold]
                                side=1
                                amount=$stolen_gold
                            [/gold]
                        [/then]
                        [else]
                            [gold]
                                side=1
                                amount=26
                            [/gold]
                        [/else]
                    )}
                    {CLEAR_VARIABLE stolen_gold}

                    [modify_side]
                        side=1
                        shroud=no
                    [/modify_side]
                    [redraw]
                    [/redraw]
                [/command]
            [/option]

            # Option: Let Vaddan join
            [option]
                message=_"No, he is right. We need another fighter and could use his knowledge of the plains."
                [command]
                    {VARIABLE Vaddan_joins yes}
                    {MODIFY_UNIT id=Vaddan side 1}
                    {MODIFY_UNIT id=Vaddan canrecruit no}
                    {MODIFY_UNIT id=Vaddan hitpoints 1}
                    {CAPTURE_FILTERED_VILLAGES_COPY 1 x,y=$unit.x,$unit.y}

                    {MESSAGE Vaddan "" "" _"You won't regret this."}
                    {IF_VAR stolen_gold greater_than 51 (
                        [then]
                            {MESSAGE Vaddan "" "" _"First, here is half of your gold back. I spent the other half, sorry."}
                            {VARIABLE_OP stolen_gold divide 2}
                            [gold]
                                side=1
                                amount=$stolen_gold
                            [/gold]
                        [/then]
                        [else]
                            {MESSAGE Vaddan "" "" _"First, here are 26 pieces of gold. That is all I have left."}
                            [gold]
                                side=1
                                amount=26
                            [/gold]
                        [/else]
                    )}
                    {CLEAR_VARIABLE stolen_gold}

                    {MESSAGE Vaddan "" "" _"Also, here is a map of the area."}
                    [modify_side]
                        side=1
                        shroud=no
                    [/modify_side]
                    [redraw]
                    [/redraw]

                    {MESSAGE Vaddan "" "" _"There are three ways to get to Pleasant Passage. The first is to go east of the river all the way to the south. It has the easiest terrain but there are two very strong orc camps down there. I doubt that you will be able to defeat them, but even if you do, it would come with heavy losses."}
                    {MESSAGE Norfindil "" "" _"At least we agree on that one..."}
                    {MESSAGE Vaddan "" "" _"The second is to go straight south from my camp and then head a little west to a mountain pass. It is the shortest route, but there is usually a strong troll contingent hanging out there."}
                    {MESSAGE Vaddan "" "" _"There is a third route by a hidden valley between two enormous mountain ranges in the west. It is hard to get into on either side and might take some time, but if you make it, the valley itself is easy going and you will likely find little opposition."}
                    {MESSAGE Vaddan "" "" _"The southern end is also guarded by trolls, but there are much fewer there than at the other pass. Also, this route will get you out of the mountains very close to the orcs by Pleasant Passage. I doubt that they are aware of this, so you might be able to take them by surprise. The south-western orc outpost is not very strong, they rely mostly on the two south-eastern camps."}
                    {MESSAGE Galuldur "" "" _"That all sounds good, but remember, I will be watching you. So what about your men? Are there any more up here in the plains that could come with us?"}
                    {MESSAGE Vaddan "" "" _"I doubt that anybody will be joining you, they don't like elves very much. We better get going, it's a long way."}

                    [kill]
                        side=3
                    [/kill]

                    {IF_VAR second_unit.side not_equals 1 (
                        [then]
                            {MESSAGE narrator "wesnoth-icon.png" "" _"Vaddan will be hidden under your protection for the rest of the turn. He will join your side at the beginning of the next turn."}
                            {VARIABLE Vaddan_hidden yes}
                            [store_unit]
                                [filter]
                                    id=Vaddan
                                [/filter]
                                variable=stored_hidden_Vaddan
                                kill=yes
                            [/store_unit]
                        [/then]
                    )}
                [/command]
            [/option]
        [/message]

        # Reset original objective
        [objectives]
            [objective]
                description= _"Move Galuldur to Pleasant Passage"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Galuldur"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Norfindil"
                condition=lose
            [/objective]
            [objective]
                description= _ "Turns run out"
                condition=lose
            [/objective]
            note={EARLY_FINISH_BONUS_NOTE}+{NEW_GOLD_CARRYOVER_NOTE_40}
        [/objectives]

        # Event: Restore Vaddan if he was protected during the last turn
        #   only needed once, on the turn after Vaddan was defeated, thus nested event
        [event]
            name=new turn
            {IF_VAR Vaddan_hidden equals yes (
                [then]
                    [unstore_unit]
                        variable=stored_hidden_Vaddan
                        find_vacant=yes
                    [/unstore_unit]
                    {CLEAR_VARIABLE stored_hidden_Vaddan}
                    {CLEAR_VARIABLE Vaddan_hidden}  # only needed here, not set otherwise
                [/then]
            )}
        [/event]

        # Event: Finish by getting to Pleasant Passage, but only after Vaddan was defeated
        #   thus, this is nested in the Vaddan event
        [event]
            name=moveto
            [filter]
                id=Galuldur
                x,y=3,39
            [/filter]

            {MESSAGE Galuldur "" "" _"Wow, that was a lot of work! But we made it."}
            [endlevel]
                result=victory
                carryover_add=yes
                carryover_percentage=40
            [/endlevel]
        [/event]
    [/event]

    # Event: Southwestern orcs are mobilized when we get too close
    [event]
        name=moveto
        [filter]
            side=1
            [filter_location]
                x=5,12
                y=36,32
                radius=5
            [/filter_location]
        [/filter]

        {NEW_LEADER_APPEARS 4 (Orcish Ruler) 4 35 Orc_Leader_SW ()}
        {UNIT 4 (Orcish Archer) 8 32 (id=Orc_Sentinel)}

        {CLEAR_FOG_FIXED 1 8 32 3}
        {CLEAR_FOG_FIXED 1 4 35 3}
        {MESSAGE Orc_Sentinel "" "Orc Sentinel" _"Someone come, over there!"}
        {MESSAGE Orc_Leader_SW "" "" _"What? How that? You say there no way through mountains or past orc brothers."}
        {MESSAGE Orc_Sentinel "" "Orc Sentinel" _"I ..."}
        {MESSAGE Orc_Leader_SW "" "" _"I punish you later! Now go, tell Chief."}

        {MOVE_AND_KILL id=Orc_Sentinel 1 39}
        {UNCLEAR_FOG_FIXED}
    [/event]

    # Event: Southeastern orcs (both of them) are mobilized when we get too close
    [event]
        name=moveto
        [filter]
            side=1
            [filter_location]
                #x,y=24,31
                #radius=8
                # Want this more specific:
                x,y=18,30-40
                [or]
                    x,y=19,31-40
                [/or]
                [or]
                    x,y=20,30-40
                [/or]
                [or]
                    x,y=21,29-40
                [/or]
                [or]
                    x,y=22,27-40
                [/or]
                [or]
                    x,y=23-42,24-40
                [/or]
            [/filter_location]
        [/filter]

        {NEW_LEADER_APPEARS 5 (Orcish Ruler) 24 31 Orc_Leader_SE1 ()}
        {NEW_LEADER_APPEARS 6 (Orcish Ruler) 31 33 Orc_Leader_SE2 ()}

        {CLEAR_FOG_FIXED 1 24 31 2}
        {CLEAR_FOG_FIXED 1 31 33 1}
        {MESSAGE Orc_Leader_SE1 "" "" _"Elves! Come from plains! To weapons!"}
        {UNCLEAR_FOG_FIXED}
    [/event]

    # Event: Spring up some trolls near Pass 1
    [event]
        name=moveto
        [filter]
            side=1
            [filter_location]
                x,y=12,24
                radius=2
            [/filter_location]
        [/filter]
        {GENERIC_UNIT 2 Troll 11 24}
        {GENERIC_UNIT 2 (Troll Whelp) 11 25}
        {GENERIC_UNIT 2 Troll 11 26}
        {UNIT 2 (Troll Warrior) 12 26 (id=Troll_Pass1)}
        {MESSAGE Troll_Pass1 "" "" _"Surprise!"}
    [/event]

    # Event: Spring up some trolls near Pass 2
    [event]
        name=moveto
        [filter]
            side=1
            [filter_location]
                x,y=4,30
                radius=2
            [/filter_location]
        [/filter]
        {UNIT 2 (Troll Hero) 4 30 (id=Troll_Pass2)}
        {GENERIC_UNIT 2 (Troll Rocklobber) 3 31}
        {MESSAGE Troll_Pass2 "" "" _"Surprise!"}
    [/event]

    # Standard Events
    {RANDOM_FOES_EVENT 2 30 (8..36) (10..20)}
    {PASS_OF_HANGARN 42 5}
    {BIG_TREE 18 22}
    {ADLEWYS_PASSAGE 28 33}
    {PLEASANT_PASSAGE 3 39}

    {DEATH_EVENTS}
    {VADDAN_DEATH_NODEFEAT_NOSPEECH}
[/scenario]
